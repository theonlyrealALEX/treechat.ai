<html>

<head>
    <title>treechat.ai</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
</head>

<body>
    <div class="botui-app-containerx" id="Tree">
        <bot-ui></bot-ui>
    </div>
    <script src="https://cdn.jsdelivr.net/vue/latest/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/botui/build/botui.js"></script>
    <script>
        var botui = new BotUI('Tree');
        var chat_history = new String("")
        var cnt = 0
        var answer = ""
        const treeAPIAddress = 'https://tree-chat-ai.ey.r.appspot.com'
        const localAPIAddress = 'http://localhost:3001'
        const currentAPIAddress = treeAPIAddress;
        let sID;

        async function getSessionID() {
            if (sID) {
                return;
            }
            sID = await (async () => {
                try {
                    const response = await fetch("/getSessionID");
                    if (response.ok) {
                        return await response.text();
                    } else {
                        console.error("Error fetching session ID:", response.status, response.statusText);
                    }
                } catch (err) {
                    console.error("Error calling /getSessionID API:", err);
                }
            })();
        }

        /*function getGPTResponse(input) {
            fetch(currentAPIAddress + "/input", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ input, sID }) // Include the sessionId in the request body
            })
                .then(response => response.json())
                .then(data => {
                    answer = data;
                    console.log(answer['content'])
                })
                .catch(error => console.error(error))
        }*/
        async function getGPTResponse(input) {
            try {
                const response = await fetch(currentAPIAddress + "/input", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ input, sID }) // Include the sessionId in the request body
                });

                const data = await response.json();
                //console.log(data);
                return data;
            } catch (error) {
                console.error(error);
            }
        }

        /*function sendMessage() {
            botui.action.text({
                action: {
                    placeholder: 'Enter your Question'
                }
            })
                .then(async function (input) {
                    console.log(input)
                    if (!sID) {
                        getSessionID().then(function () { console.log(sID, "Session ID") }).then(getGPTResponse(input))
                    } else {
                        getGPTResponse(input)
                    }
                    console.log(answer)
                }).then(input => {
                    botui.message.add({
                        loading: true,
                        human: false,
                        content: answer['content'],
                    })
                        .then(function () {
                            if (cnt < 10) {
                                sendMessage();
                                cnt += 1
                            } else {
                                botui.message.add({
                                    content: "Thanks for using TreeChat.ai"
                                })
                            }
                        })
                });
        }
        */

        function sendMessage() {
            botui.action.text({
                action: {
                    placeholder: 'Enter your Question'
                }
            })
                .then((text) => {
                    botui.message.add({
                        loading: false, //TRUE makes a loading animation, but i won't go away when the message arrives, so sth has to be done about it
                        human: false,
                        content: "Fetching Response",
                    })
                    return text;
                })
                .then((text) => getGPTResponse(text))
                .then((gptOutput) => {
                    const contentGPT = gptOutput['content']
                    console.log(contentGPT)

                    botui.message.add({
                        loading: false,
                        human: false,
                        content: contentGPT,
                    })
                    sendMessage();
                })
        }
        botui.message.add({
            content: "Welcome to TreeChat.ai."
        })
            .then(function () {
                botui.message.add({
                    content: "Ask me some questions about the Pasinger Arcaden."
                })
            })
            .then(getSessionID())
            .then(sendMessage())
    </script>
</body>

</html>